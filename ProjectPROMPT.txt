### Project Overview

The **MoneyFlow Python** project is a web-based financial management application migrated from a Flutter app. It uses **Flask** as the web framework to render a dynamic, advanced web UI. All data persistence is handled via **encrypted files** on the filesystem (no databases). Files use custom extensions like `.mfc` (MoneyFlow Credentials) for user data, `.mfe` for expenses, `.mfb` for budgets, etc., to denote encrypted MoneyFlow files. Encryption is symmetric using `cryptography.Fernet`, with an app-wide master key stored in `.env` (for simplicity; can be enhanced later).

**Key Features** (mirroring Flutter app):
- **Authentication**: User registration, login, logout. Uses bcrypt for password hashing and Flask sessions for state management (with JWT optional for API-like endpoints if needed).
- **Expense Tracking**: Add/edit/delete expenses with categories (e.g., food, travel). Supports filtering, searching.
- **Budget Management**: Create/edit/delete budgets, track progress against expenses.
- **Financial Insights**: Analytics like spending trends, charts (using Chart.js for visualizations).
- **Notifications**: In-app alerts (e.g., budget exceeded) displayed via UI banners or modals.
- **Reports**: Generate/export reports (e.g., PDF via ReportLab or HTML-to-PDF) for expenses/budgets.

**Security**:
- All data files encrypted with Fernet (key from `.env`).
- Input sanitization via WTForms or manual validation.
- Session-based auth with CSRF protection (Flask-WTF).

**Tech Stack**:
- Python 3.9+
- Flask (web framework)
- Jinja2 (templates)
- Bootstrap 5 (styling), Chart.js (charts), jQuery (interactivity)
- cryptography (encryption), passlib (bcrypt), PyJWT (if needed)
- WTForms (forms validation)
- ReportLab (for PDF reports, optional)

**Web UI Design** (Advanced):
- Responsive design with Bootstrap.
- Single-page app feel using AJAX (jQuery) for dynamic updates (e.g., add expense without reload).
- Interactive elements: Modals for forms, real-time charts for insights, toast notifications.
- Dashboard with widgets (e.g., budget progress bars, expense pie charts).
- Navigation: Sidebar or navbar for sections (Dashboard, Expenses, Budgets, Insights, Notifications, Reports, Profile).
- Accessibility: ARIA labels, keyboard navigation.
- Error handling: User-friendly messages, 404/500 pages.

**Assumptions/Decisions** (based on prior chat):
- Encryption key: App-wide from `.env` (e.g., `ENCRYPTION_KEY` generated via `Fernet.generate_key()`).
- File organization: `./data/users/<user_id>_<type>.<ext>` (user_id = hashed email for uniqueness).
- Multi-user: Separate files per user.
- Session: Flask's built-in sessions (file-based or in-memory).
- No external APIs; all local.
- Testing: Basic unit tests in each module (using pytest).

**Development Approach**:
- Break into **manageable sections** (phases). Each section is self-contained, with a **detailed spec** and **prompt template** you can copy-paste to another AI for implementation.
- Each section focuses on 3-5 files, with code skeletons or key logic.
- After all sections, the project is 90%+ done (runnable with minor tweaks like key generation).
- Run app: `python app/main.py` (uses `flask run` internally).

### File Structure with Descriptions

```
moneyflow-python/
├── app/                     # Core Flask app setup and entry points
│   ├── __init__.py          # Creates Flask app instance, registers blueprints, configs extensions (e.g., sessions, WTF)
│   ├── main.py              # Entry point: Runs the app (if __name__ == '__main__': app.run())
│   ├── config.py            # App configs: SECRET_KEY, ENCRYPTION_KEY (from .env), file paths
│   └── routes.py            # Main routes (e.g., /dashboard, /logout) not in blueprints
│
├── core/                    # Shared utilities
│   ├── __init__.py
│   ├── security.py          # Encryption/decryption (Fernet), hashing (bcrypt), JWT utils if needed
│   └── exceptions.py        # Custom exceptions (e.g., InvalidCredentialsError, FileEncryptionError)
│
├── models/                  # Data models (using dataclasses or Pydantic for validation)
│   ├── __init__.py
│   ├── user.py              # User model: id, email, full_name, hashed_password
│   ├── expense.py           # Expense: id, amount, category, date, description
│   ├── budget.py            # Budget: id, category, amount, period (monthly/yearly)
│   └── notification.py      # Notification: id, message, type (alert/info), timestamp
│
├── services/                # Business logic (e.g., validate + call repos)
│   ├── __init__.py
│   ├── auth_service.py      # Handles register/login/validate (mirrors Flutter AuthProvider)
│   ├── user_service.py      # User profile updates
│   ├── expense_service.py   # Add/edit/delete expenses, calculate totals
│   ├── budget_service.py    # Create budgets, check against expenses
│   ├── insight_service.py   # Analytics: trends, charts data
│   ├── notification_service.py # Generate/send notifications (UI-based)
│   └── report_service.py    # Generate reports (JSON to HTML/PDF)
│
├── repositories/            # Data access layer (file I/O with encryption)
│   ├── __init__.py
│   ├── base.py              # Base class for repos: load/save encrypted JSON
│   ├── user_repository.py   # CRUD for user .mfc files
│   ├── expense_repository.py # CRUD for .mfe files
│   ├── budget_repository.py # CRUD for .mfb files
│   └── notification_repository.py # CRUD for .mfn files (notifications)
│
├── storage/                 # Low-level file handling
│   ├── __init__.py
│   ├── secure_storage.py    # Encrypt/decrypt files using Fernet
│   └── file_handler.py      # Safe file read/write, path utils
│
├── blueprints/              # Modular routes (for organization)
│   ├── __init__.py
│   ├── auth.py              # Routes: /login, /register
│   ├── expenses.py          # Routes: /expenses (list/add/edit/delete with AJAX)
│   ├── budgets.py           # Similar for budgets
│   ├── insights.py          # /insights (charts, analytics)
│   ├── notifications.py     # /notifications (list/clear)
│   └── reports.py           # /reports (generate/download)
│
├── templates/               # Jinja2 HTML templates (advanced UI)
│   ├── base.html            # Base layout: navbar, sidebar, footer (Bootstrap)
│   ├── login.html           # Login form (WTForms, validation)
│   ├── register.html        # Registration form
│   ├── dashboard.html       # Overview widgets (charts, summaries)
│   ├── expenses.html        # Table with filters, modal for add/edit (DataTables.js for advanced table)
│   ├── budgets.html         # Progress bars, forms
│   ├── insights.html        # Chart.js integrations (pie/line charts)
│   ├── notifications.html   # List with dismiss buttons
│   ├── reports.html         # Preview/download buttons
│   └── 404.html             # Error page
│
├── static/                  # Assets for advanced UI
│   ├── css/                 # Custom styles.css (overrides Bootstrap)
│   ├── js/                  # scripts.js (AJAX calls, Chart.js setups, modals)
│   └── img/                 # Logos, icons
│
├── data/                    # Runtime data (encrypted files; gitignore this)
│   └── users/               # Per-user folders or files (e.g., user123_expenses.mfe)
│
├── tests/                   # Unit tests (pytest)
│   ├── test_security.py     # Test encryption
│   └── test_services.py     # Test business logic
│
├── requirements.txt         # Dependencies: flask, cryptography, passlib, wtforms, reportlab, etc.
├── .env.example             # Template: SECRET_KEY, ENCRYPTION_KEY
├── .gitignore               # Ignore data/, __pycache__, .env
└── README.md                # Setup instructions, run guide
```

### Breakdown into Manageable Sections

I've divided the project into **8 sections** (phases). Each is self-contained, building on prior ones. For each, I provide:
- **Dependencies**: What prior sections are needed.
- **Files Involved**: List with brief roles.
- **Detailed Spec**: Key implementation notes.
- **Prompt Template**: A copy-paste prompt for another AI to generate the code. (Tune as needed; specify "generate complete, functional code" for 90% completeness.)

Implement in order: Start with Section 1, test, then next.

#### Section 1: Setup and Core Utilities
**Goal**: Foundation (configs, encryption, exceptions).
**Dependencies**: None.
**Files**: app/__init__.py, app/main.py, app/config.py, core/security.py, core/exceptions.py, storage/secure_storage.py, storage/file_handler.py, requirements.txt, .env.example, .gitignore.
**Detailed Spec**:
- Config: Load from .env (dotenv).
- Security: Fernet init with key; encrypt/decrypt strings; bcrypt hash/verify.
- Secure Storage: Class to encrypt/decrypt JSON to/from files (e.g., store(dict) -> encrypt JSON -> write .mfc).
- File Handler: Utils for safe paths (e.g., os.makedirs for data/users).
- App Init: Flask(app), config.from_object, session setup.
- Main: app.run(debug=True).
- Requirements: List all libs.

**Prompt Template**:
```
Generate complete, functional code for Section 1 of MoneyFlow Python project. Use Flask for web, no DB, encrypted files. Implement files: [list files]. Details: [paste Detailed Spec]. Ensure encryption uses cryptography.Fernet with app-wide key from .env. Make it runnable (basic / route for testing). Output each file's code separately.
```

#### Section 2: Models
**Goal**: Define data structures.
**Dependencies**: Section 1 (for exceptions).
**Files**: models/__init__.py, models/user.py, models/expense.py, models/budget.py, models/notification.py.
**Detailed Spec**:
- Use dataclasses or Pydantic BaseModel for validation.
- User: id (uuid), email (str), full_name (str), hashed_password (str).
- Expense: id, user_id, amount (float), category (str enum: 'food', 'travel', etc.), date (datetime), desc (str).
- Budget: id, user_id, category, amount, period (str: 'monthly'), start_date.
- Notification: id, user_id, message, type, timestamp.
- Include methods like to_dict/from_dict for JSON serialization.

**Prompt Template**:
```
Generate complete code for Section 2: Models. Base on prior sections. Use Pydantic for validation. Files: [list]. Specs: [paste Detailed Spec]. Ensure models are serializable for file storage.
```

#### Section 3: Repositories
**Goal**: File-based CRUD.
**Dependencies**: Sections 1-2.
**Files**: repositories/__init__.py, repositories/base.py, repositories/user_repository.py, repositories/expense_repository.py, repositories/budget_repository.py, repositories/notification_repository.py.
**Detailed Spec**:
- BaseRepo: Abstract methods (get_by_id, save, delete); handles encryption via secure_storage.
- UserRepo: register (create .mfc), login (load/verify), get_user.
- ExpenseRepo: list/add/update/delete expenses (load .mfe as list[Expense], append/save).
- Similar for others.
- File paths: f"data/users/{hash(email)}_{type}.{ext}".

**Prompt Template**:
```
Implement Section 3: Repositories. Use encrypted file I/O. Files: [list]. Specs: [paste Detailed Spec]. Make CRUD operations atomic (use locks if needed). Testable with mock data.
```

#### Section 4: Services
**Goal**: Business logic.
**Dependencies**: Sections 1-3.
**Files**: services/__init__.py, services/auth_service.py, services/user_service.py, services/expense_service.py, services/budget_service.py, services/insight_service.py, services/notification_service.py, services/report_service.py.
**Detailed Spec**:
- AuthService: register (hash pw, save via repo), login (verify bcrypt).
- ExpenseService: add (validate amount >0), get_totals_by_category.
- BudgetService: check if exceeded (compare to expenses).
- InsightService: generate chart data (e.g., dict for Chart.js: categories, amounts).
- NotificationService: create alert if budget exceeded.
- ReportService: Compile data to dict, format for HTML/PDF.

**Prompt Template**:
```
Generate Section 4: Services. Call repos, add validation. Files: [list]. Specs: [paste Detailed Spec]. Include logic for insights (e.g., aggregate expenses).
```

#### Section 5: Blueprints and Routes
**Goal**: API-like routes (but Flask views).
**Dependencies**: Sections 1-4.
**Files**: blueprints/__init__.py, blueprints/auth.py, blueprints/expenses.py, etc., app/routes.py (for dashboard).
**Detailed Spec**:
- Use Blueprint for modularity (register in app/__init__.py).
- Auth: POST /login (form, set session['user_id']), GET /logout.
- Expenses: GET /expenses (render list), POST /expenses/add (AJAX JSON response).
- Protect routes with @login_required (custom decorator using session).
- Handle forms with WTForms.
- AJAX: Return JSON for dynamic updates.

**Prompt Template**:
```
Implement Section 5: Blueprints/Routes. Use Flask views, sessions for auth. Files: [list]. Specs: [paste Detailed Spec]. Include login_required decorator.
```

#### Section 6: Templates and Static Assets
**Goal**: Advanced UI.
**Dependencies**: Sections 1-5.
**Files**: templates/*, static/css/styles.css, static/js/scripts.js, static/img/*.
**Detailed Spec**:
- base.html: Bootstrap CDN, navbar with links, sidebar.
- Forms: WTForms rendering.
- expenses.html: Bootstrap table + DataTables.js (CDN) for search/sort, modal for add (Bootstrap Modal).
- insights.html: <canvas> for Chart.js, load data via AJAX.
- scripts.js: jQuery AJAX for form submits, chart rendering, toasts for notifications.
- styles.css: Custom themes (e.g., colors for budgets).

**Prompt Template**:
```
Create Section 6: Templates/Static. Advanced UI with Bootstrap, Chart.js, AJAX. Files: [list]. Specs: [paste Detailed Spec]. Make interactive: modals, real-time updates.
```

#### Section 7: Tests
**Goal**: Ensure functionality.
**Dependencies**: All prior.
**Files**: tests/*.
**Detailed Spec**:
- pytest: Test encryption round-trip, auth login, expense add.
- Mock files/storage for isolation.

**Prompt Template**:
```
Write Section 7: Tests. Use pytest. Files: [list]. Specs: [paste Detailed Spec]. Cover 80%+ code.
```

#### Section 8: Documentation and Final Touches
**Goal**: Polish for 90% completeness.
**Dependencies**: All.
**Files**: README.md.
**Detailed Spec**:
- Install: pip install -r requirements.txt, cp .env.example .env, generate keys.
- Run: python app/main.py.
- Usage: Features list, screenshots if possible.

**Prompt Template**:
```
Complete Section 8: Docs. Make project runnable. Files: [list]. Specs: [paste Detailed Spec].
```

This breakdown ensures progressive building. After all sections, test end-to-end: Register user, add expense, view insights, etc. If issues, iterate per section. The project will be highly functional (90%+), needing only minor customizations like advanced error logging.